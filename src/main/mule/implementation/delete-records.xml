<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd 
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
	<sub-flow name="delete-records-sub-flow" doc:id="ef9f41c0-bff9-4006-9477-f3bdd74a935b" >
		<logger level="INFO" doc:name="START" doc:id="e2f0ea89-0344-4198-aa17-84b4e6f657f3" message="#[%dw 2.0 &#10;output application/json&#10;---&#10;{&#10;	&quot;flowName&quot;: flow.name,&#10;	&quot;table&quot;: attributes.headers.'table-name',&#10;	&quot;timeStamp&quot;: now(),&#10;	&quot;correlationId&quot;: vars.correlationId,&#10;	&quot;message&quot;: &quot;The flow has started.&quot;&#10;}]"/>
		<ee:transform doc:name="Preparing Query" doc:id="d52d844e-0528-46c5-9a77-14f2792e6f76">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/java

var table      = attributes.headers.'table-name' default ""
var primaryKey = attributes.headers.'primary-key'

---
{
  sql: "DELETE FROM " ++ table ++ " WHERE " ++ primaryKey ++ " = :" ++ primaryKey,
  param: {
  	(primaryKey): attributes.uriParams.'id'
  }
}
]]></ee:set-payload>
					</ee:message>
				</ee:transform>
		<db:delete doc:name="Records" doc:id="bc3bf35e-dc60-4449-94a5-2fe293c1a180" config-ref="oms-sys-api-database-config" target="dbOutput">
			<db:sql ><![CDATA[#[payload.sql]]]></db:sql>
			<db:input-parameters ><![CDATA[#[payload.param]]]></db:input-parameters>
		</db:delete>
		<choice doc:name="Records found?" doc:id="c84e4158-adfd-41f4-a8fe-cb1c6bad966c" >
			<when expression="#[vars.dbOutput == 0]">
				<raise-error doc:name="CUSTOM:NO_RECORD_FOUND" doc:id="5c6c4a46-ebad-4287-aec3-c07a64e9b815" type="CUSTOM:NO_RECORD_FOUND" description="No records found in the table." />
			
</when>
			<otherwise >
				<ee:transform doc:name="Preparing Response" doc:id="8062993b-77fa-48ca-883a-c8c617cb784a">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	"message": "Record with "++ attributes.headers.'primary-key' ++ " - " ++ attributes.uriParams.id ++ " deleted successfully."
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
			</otherwise>
		</choice>
		<logger level="INFO" doc:name="END" doc:id="2151d018-b505-4c78-92ce-3284f4ef6c21" message="#[%dw 2.0 &#10;output application/json&#10;---&#10;{&#10;	&quot;flowName&quot;: flow.name,&#10;	&quot;table&quot;: attributes.headers.'table-name',&#10;	&quot;timeStamp&quot;: now(),&#10;	&quot;correlationId&quot;: vars.correlationId,&#10;	&quot;message&quot;: &quot;The flow has ended.&quot;&#10;}]"/>
	</sub-flow>
	</mule>
