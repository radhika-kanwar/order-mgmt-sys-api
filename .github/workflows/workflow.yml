# The name of the workflow, which is displayed in the GitHub Actions tab. 
name: Deploying Mule application to CloudHub 2.0

# Defining the trigger
on:
  # Manual trigger
  workflow_dispatch:
    # Parameters for manual trigger workflows
    inputs:
      environment:
        description: "Deployment Environment"
        required: true
        type: choice
        options:
          - DEV
          - UAT
          - PROD
      
      java:
        description: "Java Version"
        required: true
        type: choice
        options:
          - '8'
          - '17'
      
      target:
        description: "CloudHub2 Target"
        required: true
        default: "Cloudhub-US-East-1"
      
      releaseChannel:
        description: "Deployment Release Channel"
        required: true
        default: "edge"
      
      replica:
        description: "Number of Replicas"
        required: true
        default: "1"
      
      vCore:
        description: "vCore Allocation"
        required: true
        default: "0.1"
      
      commit:
        description: "Commit Message"
        required: true
        type: string
        
# Workflow run name
run-name: "Commit: ${{ inputs.commit }} | Env: ${{ inputs.environment }} | App: oms-sys-api"

# Defining stages in the CI/CD  pipeline
jobs:

# 1. Running MUnit Tests
  Test:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4

      - name: "Cache Maven Dependencies"
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}

      - name: "Setup Java ${{ inputs.java }}"
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '${{ inputs.java }}'

      - name: "Run MUnit Tests"
        run: mvn clean test -Dmule.env="${{ vars.env }}" -Dmule.key="${{ secrets.enc_key }}" -DCONNECTED_APP_ID="${{ secrets.connected_app_id }}" -DCONNECTED_APP_SECRET="${{ secrets.connected_app_secret }}" --settings settings/settings.xml
        
      - name: "Upload MUnit Report"
        uses: actions/upload-artifact@v4
        with:
          name: "Munit Coverage Report"
          path: target/site/munit/coverage
          retention-days: 2
          
# 2. Building the Mule application
  Build:
  # Environment where the job executes
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      # Pulling the repoâ€™s code into the runner environment
      - name: "Checkout Repository ${{ github.repository }}"
        # Actions - Reusable modules from GitHub Marketplace
        uses: actions/checkout@v4 # version 4 of the checkout action

      # Used for saving and restoring caches 
      - name: "Cache Dependencies"
        uses: actions/cache@v4
        # Providing input parameters to actions
        with:
          # Defining the file-system path to cache
          path: ~/.m2/repository
          # Uniquely identifies the contents of the cache (when to restore or refresh dependencies)
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml')}}

      - name: "Setup Java ${{ inputs.java }}"
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '${{ inputs.java }}'

      - name: "Build Mule Application"
        run: |
          mvn -B clean package -Dmule.env="${{ vars.env }}" -Dmule.key="${{ secrets.enc_key }}" -DskipTests -DCONNECTED_APP_ID="${{ secrets.connected_app_id }}" -DCONNECTED_APP_SECRET="${{ secrets.connected_app_secret }}" --settings settings/settings.xml

      - name: "Upload Built Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: "Artifacts"
          path: target/*.jar
          retention-days: 2

  # 3. Publishing the asset to Exchange
  Publish-To-Exchange:
      needs: Build
      runs-on: ubuntu-latest
      environment: ${{ inputs.environment }}
      
      steps:
      - name: "Checkout Repository ${{ github.repository }}"
        uses: actions/checkout@v4
        
      - name: "Cache Dependencies"
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
            
      - name: "Download the JAR File"
        uses: actions/download-artifact@v4
        with:
          name: "Artifacts"
          path: target/
          
      - name: "Publish to Exchange"
        run: mvn deploy -DskipTests -Dmule.env="${{ vars.env }}" -Dmule.key="${{ secrets.enc_key }}" -DskipTests -DCONNECTED_APP_ID="${{ secrets.connected_app_id }}" -DCONNECTED_APP_SECRET="${{ secrets.connected_app_secret }}" --settings settings/settings.xml

  # 4. Deploying the application to CloudHub 2.0
  Deploy-To-CloudHub:
    needs: Publish-To-Exchange
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: "Checkout Repository ${{ github.repository }}"
        uses: actions/checkout@v4

      - name: "Cache Dependencies"
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}

      - name: "Download Built Artifact"
        uses: actions/download-artifact@v4
        with:
          name: "Artifacts"
          path: target/

      - name: "Deploy to CloudHub 2.0"
        run: |
          mvn deploy -DmuleDeploy -DskipTests \
            -Denvironment="${{ inputs.environment }}" \
            -Dtarget="${{ inputs.target }}" \
            -DreleaseChannel="${{ inputs.releaseChannel }}" \
            -DjavaVersion="${{ inputs.java }}" \
            -Dreplica="${{ inputs.replica }}" \
            -DvCore="${{ inputs.vCore }}" \
            -D"mule.env"="${{ vars.env }}" \
            -D"mule.key"="${{ secrets.enc_key }}" \
            -DapplicationName="oms-sys-api-${{ vars.env }}" \
            -DCONNECTED_APP_ID="${{ secrets.connected_app_id }}" \
            -DCONNECTED_APP_SECRET="${{ secrets.connected_app_secret }}" \
            --settings settings/settings.xml

